{% extends 'base_header_breadcrumbs.html' %}

{% block title %}企业申报-昆山开发区科技局信息系统{% endblock %}

{% block styles %}
    <link href="{{ url_for('static', filename='css/select2.min.css') }}" rel="stylesheet"/>
{% endblock %}

{% block header_right %}
    {% if can_write %}
        <button class="btn btn-primary lift" data-toggle="modal" data-target="#newProjectModal">
            <i class="fe fe-plus"></i> 添加项目
        </button>
    {% endif %}
{% endblock %}

{% block main %}
    <div class="container-fluid">
        <div class="card">
            <div class="card-table">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                        <tr>
                            <th>企业</th>
                            <th>状态</th>
                            <th>进度</th>
                            <th>截止时间</th>
                            {% if can_write %}
                                <th>操作</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody id="file-container">
                        {% for project in distribute_projects %}
                            <tr>
                                <td class="nowrap" style="max-width: 200px;">
                                    <a href="{{ url_for("project_declaration.project_task_info", distribute_id=project["distribute_id"]) }}">
                                        {{ project["ep_name"] }}
                                    </a>
                                </td>
                                <td class="project-status">
                                    {% if project.status == 0 %}
                                        <span class="badge badge-info">进行中</span>
                                    {% elif project.status == 1 %}
                                        <span class="badge badge-success">已完成</span>
                                    {% endif %}
                                </td>
                                <td class="project-progress">
                                    <div>{{ project.complete_num }} / {{ project.task_num }}</div>
                                    <div class="progress progress-sm" style="min-width: 130px;">
                                        <div class="progress-bar bg-secondary" role="progressbar"
                                             style="width: {{ project.progress }}%"
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </td>
                                <td class="nowrap">
                                    {{ project["gmt_deadline"] }}
                                </td>
                                {% if can_write %}
                                    <td>
                                        {% if project.status == 1 or current_user.category_id != 2 %}
                                            <span></span>
                                        {% elif project.status == -1 %}
                                            <form action="{{ url_for("project_declaration.update_status_to_delete") }}"
                                                  method="post"
                                                  onclick="return confirm('确定终止项目?')" class="d-inline">
                                                <input hidden name="csrf_token" value="{{ csrf_token() }}">
                                                <input hidden name="distribute_id"
                                                       value="{{ project["distribute_id"] }}">
                                                <button class="btn btn-sm text-danger font-size-lg audit_no_pass"
                                                        title="中止项目" type="submit">
                                                    <i class="cursor-pointer fe fe-x-circle"></i>
                                                </button>
                                            </form>
                                        {% elif project.status == 0 %}
                                            <form action="{{ url_for("project_declaration.update_status_to_complete") }}"
                                                  method="post" class="d-inline">
                                                <input hidden name="csrf_token" value="{{ csrf_token() }}">
                                                <input hidden name="progress" value="{{ project.progress }}">
                                                <input hidden name="distribute_id"
                                                       value="{{ project["distribute_id"] }}">
                                                <button class="btn btn-sm text-success font-size-lg audit_pass"
                                                        title="项目申报成功" type="submit">
                                                    <i class="cursor-pointer fe fe-check-circle"></i>
                                                </button>
                                            </form>
                                            <form action="{{ url_for("project_declaration.update_status_to_delete") }}"
                                                  method="post"
                                                  onclick="return confirm('确定终止项目?')" class="d-inline">
                                                <input hidden name="csrf_token" value="{{ csrf_token() }}">
                                                <input hidden name="distribute_id"
                                                       value="{{ project["distribute_id"] }}">
                                                <button class="btn btn-sm text-danger font-size-lg audit_no_pass"
                                                        title="中止项目" type="submit">
                                                    <i class="cursor-pointer fe fe-x-circle"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        {% if distribute_projects|length == 0 %}
                            <tr>
                                <td colspan="6" class="text-center">暂无申报项目</td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    {% if can_write %}
        <div class="modal fade" id="newProjectModal" role="dialog" aria-labelledby="taskOperateModalLabel">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="taskOperateModalLabel">新建项目分配</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <form class="form-horizontal" action="{{ url_for('project_declaration.add_declaration_project') }}"
                          method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-body">
                            <div class="form-row">
                                <label for="ep_id" class="col-sm-2 col-form-label">企业</label>
                                <div class="col-10">
                                    <select class="form-control singleSelect select2" name="ep_id" id="ep_id">
                                        <option value="" selected>请选择企业</option>
                                        {% for ep in all_ep_in_company %}
                                            <option value="{{ ep["id"] }}">{{ ep["name"] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <label class="col-sm-2 col-form-label">项目</label>
                                <div class="col-10">
                                    <input type="hidden" name="project_id" value="{{ project_id }}">
                                    <input type="text" class="form-control" value="{{ project_name }}" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <label for="gmt_deadline" class="col-sm-2 col-form-label">截止日期</label>
                                <div class="col-10">
                                    <input name="gmt_deadline" type="date" id="gmt_deadline" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" id="submit-task" class="btn btn-primary">提交</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/select2.js') }}"></script>
    <script>
        let project_id = "{{ project_id }}";
        $(document).ready(function () {
            $('.select2').select2();
            $("#gmt_deadline").val(localStorage.getItem(project_id));
        });

        $("#submit-task").on("click", function (e) {
            localStorage.setItem(project_id, $("#gmt_deadline").val());
        });

    </script>
{% endblock %}